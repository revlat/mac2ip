# Build mac2ip for all supported platforms
# Note: Only native builds work due to CGo dependency (gopacket/pcap)

name: Go

on:
  push:
    branches: [ "main" ]
    tags:
      - 'v*'
  pull_request:
    branches: [ "main" ]

jobs:
  build-linux-amd64:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Build with Alpine (static binary)
      run: |
        docker run --rm -v "$PWD":/workspace -w /workspace alpine:latest sh -c '
          apk add --no-cache go libpcap-dev musl-dev gcc file
          export CGO_ENABLED=1
          export CGO_LDFLAGS="-static"
          go build -v -ldflags "-linkmode external -extldflags \"-static\"" -o mac2ip .
          ls -lh mac2ip
          echo "=== Check if static ==="
          ldd mac2ip 2>&1 || echo "✓ Static binary (no dynamic dependencies)"
          file mac2ip
        '

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: mac2ip-linux-amd64
        path: mac2ip

    - name: Test
      run: docker run --rm -v "$PWD":/workspace -w /workspace alpine:latest sh -c 'apk add --no-cache go libpcap-dev musl-dev gcc && CGO_ENABLED=1 go test -v ./...'

  build-linux-arm64:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up QEMU for ARM64
      uses: docker/setup-qemu-action@v3

    - name: Build with Alpine ARM64 (static binary)
      run: |
        docker run --rm --platform linux/arm64 -v "$PWD":/workspace -w /workspace alpine:latest sh -c '
          apk add --no-cache go libpcap-dev musl-dev gcc file
          export CGO_ENABLED=1
          export CGO_LDFLAGS="-static"
          go build -v -ldflags "-linkmode external -extldflags \"-static\"" -o mac2ip .
          ls -lh mac2ip
          echo "=== Check if static and arm64 ==="
          ldd mac2ip 2>&1 || echo "✓ Static binary (no dynamic dependencies)"
          file mac2ip
        '

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: mac2ip-linux-arm64
        path: mac2ip

  build-macos-arm64:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.24'

    - name: Install libpcap
      run: brew install libpcap

    - name: Build
      run: |
        LIBPCAP_PREFIX=$(brew --prefix libpcap)
        export CGO_CFLAGS="-I${LIBPCAP_PREFIX}/include"
        export CGO_LDFLAGS="-L${LIBPCAP_PREFIX}/lib"
        go build -v -o mac2ip .
        ls -lh mac2ip

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: mac2ip-darwin-arm64
        path: mac2ip

  build-windows-amd64:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.24'

    - name: Install Npcap SDK
      run: |
        Invoke-WebRequest -Uri "https://npcap.com/dist/npcap-sdk-1.13.zip" -OutFile "npcap-sdk.zip"
        Expand-Archive -Path npcap-sdk.zip -DestinationPath npcap-sdk
        echo "CGO_ENABLED=1" >> $env:GITHUB_ENV
        echo "CGO_CFLAGS=-I$(Get-Location)\npcap-sdk\Include" >> $env:GITHUB_ENV
        echo "CGO_LDFLAGS=-L$(Get-Location)\npcap-sdk\Lib\x64" >> $env:GITHUB_ENV

    - name: Build
      run: |
        go build -v -o mac2ip.exe .
        dir mac2ip.exe

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: mac2ip-windows-amd64
        path: mac2ip.exe

  release:
    needs: [build-linux-amd64, build-linux-arm64, build-macos-arm64, build-windows-amd64]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
    - uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Prepare release files
      run: |
        mkdir release
        # Package Linux amd64
        cd artifacts/mac2ip-linux-amd64 && tar -czf ../../release/mac2ip-linux-amd64.tar.gz mac2ip && cd -
        # Package Linux arm64 (if available)
        if [ -d "artifacts/mac2ip-linux-arm64" ]; then
          cd artifacts/mac2ip-linux-arm64 && tar -czf ../../release/mac2ip-linux-arm64.tar.gz mac2ip && cd -
        fi
        # Package macOS arm64
        cd artifacts/mac2ip-darwin-arm64 && tar -czf ../../release/mac2ip-darwin-arm64.tar.gz mac2ip && cd -
        # Package Windows
        cd artifacts/mac2ip-windows-amd64 && zip ../../release/mac2ip-windows-amd64.zip mac2ip.exe && cd -
        ls -lh release/

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: release/*
        generate_release_notes: true
